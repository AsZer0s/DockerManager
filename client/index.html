<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Docker Manager - å®¹å™¨ç®¡ç†ç³»ç»Ÿ</title>
    <meta name="description" content="åŠŸèƒ½å¼ºå¤§çš„ Docker å®¹å™¨ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå¤šæœåŠ¡å™¨ç®¡ç†ã€å®æ—¶ç›‘æ§ã€Web SSH æ§åˆ¶å°" />
    <meta name="keywords" content="Docker,å®¹å™¨ç®¡ç†,æœåŠ¡å™¨ç›‘æ§,SSH,Telegramæœºå™¨äºº" />
    <!-- å…è®¸å¤–éƒ¨è„šæœ¬å’Œå†…è”è„šæœ¬çš„ CSP -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://telegram.org; object-src 'none';">
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Telegram Web App æ£€æµ‹å’Œåˆå§‹åŒ– - ä»…å¯¹ /telegram-webapp è·¯å¾„ç”Ÿæ•ˆ -->
    <script>
        (function() {
          // åªå¯¹ /telegram-webapp è·¯å¾„è¿›è¡Œæ£€æµ‹
          if (window.location.pathname === '/telegram-webapp') {
            
            // è·å–ç”¨æˆ·ä¿¡æ¯çš„å‡½æ•°
            function getUserInfo() {
              const info = { user_id: null, chat_id: null, message_id: null };

              try {
                const tg = window.Telegram?.WebApp;
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                  info.user_id = tg.initDataUnsafe.user.id.toString();
                  console.log('è·å–ç”¨æˆ·ID:', info.user_id);
                }
              } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
              }

              const urlParams = new URLSearchParams(window.location.search);
              if (!info.user_id) {
                const urlUserId = urlParams.get('user_id');
                if (urlUserId) {
                  info.user_id = urlUserId;
                }
              }

              info.chat_id = urlParams.get('chat_id');
              info.message_id = urlParams.get('message_id');

              if (!info.user_id) {
                console.error('æ— æ³•è·å–ç”¨æˆ·ID');
              }

              return info;
            }

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            function showError(message) {
              document.body.innerHTML = `
                <div style="
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                  display: flex; 
                  justify-content: center; 
                  align-items: center; 
                  height: 100vh; 
                  margin: 0; 
                  background: #f5f5f5;
                ">
                  <div style="
                    text-align: center; 
                    background: white; 
                    padding: 40px; 
                    border-radius: 12px; 
                    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                    max-width: 400px;
                  ">
                    <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                    <h1 style="color: #333; margin-bottom: 16px;">é”™è¯¯</h1>
                    <p style="color: #666; line-height: 1.6; margin-bottom: 20px;">${message}</p>
                    <a href="https://t.me/DockerManger_Bot" style="
                      display: inline-block; 
                      background: #0088cc; 
                      color: white; 
                      padding: 12px 24px; 
                      text-decoration: none; 
                      border-radius: 8px; 
                      font-weight: 500;
                    " onmouseover="this.style.background='#006699'" onmouseout="this.style.background='#0088cc'">
                      æ‰“å¼€ Telegram æœºå™¨äºº
                    </a>
                  </div>
                </div>
              `;
            }

            // è·å–ç”¨æˆ·ä¿¡æ¯å¹¶è®¤è¯
            async function fetchUserInfoByTelegram(userId) {
              try {
                const response = await fetch('/api/telegram-webapp/auth', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    user_id: userId
                  }),
                });

                const data = await response.json();
                if (data.success) {
                  window.authToken = data.token;
                  window.userInfo = data.user;
                  return data;
                } else {
                  throw new Error(data.message || 'è®¤è¯å¤±è´¥');
                }
              } catch (error) {
                console.error('è®¤è¯å¤±è´¥:', error);
                throw error;
              }
            }

            // è·å–æœåŠ¡å™¨åˆ—è¡¨
            async function fetchEmbyServers(userId) {
              try {
                const response = await fetch('/api/telegram-webapp/servers', {
                  headers: {
                    'Authorization': `Bearer ${window.authToken}`
                  }
                });

                const data = await response.json();
                if (data.success) {
                  window.serversList = data.servers;
                  return data.servers;
                } else {
                  throw new Error(data.message || 'è·å–æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥');
                }
              } catch (error) {
                console.error('è·å–æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error);
                throw error;
              }
            }

            // è·å–ç«™ç‚¹è®¾ç½®
            async function fetchSiteSettings() {
              try {
                const response = await fetch('/api/settings/site', {
                  headers: {
                    'Authorization': `Bearer ${window.authToken}`
                  }
                });

                const data = await response.json();
                if (data.success) {
                  window.siteSettings = data.settings;
                  return data.settings;
                } else {
                  console.warn('è·å–ç«™ç‚¹è®¾ç½®å¤±è´¥:', data.message);
                  return null;
                }
              } catch (error) {
                console.warn('è·å–ç«™ç‚¹è®¾ç½®å¤±è´¥:', error);
                return null;
              }
            }

            const initializeData = async () => {
              // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿Telegram WebAppå®Œå…¨åŠ è½½
              await new Promise(resolve => setTimeout(resolve, 100));
              
              // åˆå§‹åŒ– Telegram WebApp
              if (window.Telegram?.WebApp) {
                const webApp = window.Telegram.WebApp;
                webApp.ready();
                webApp.expand();
                
                const telegramUserData = webApp.initDataUnsafe?.user;
                
                if (telegramUserData) {
                  // è®¾ç½®å…¨å±€å˜é‡ä¾› React ç»„ä»¶ä½¿ç”¨
                  window.telegramUserData = telegramUserData;
                  window.telegramWebApp = webApp;
                  
                  try {
                    // è·å–ç”¨æˆ·ä¿¡æ¯
                    const userInfo = getUserInfo();
                    
                    if (userInfo.user_id) {
                      // æ‰§è¡Œæ‰€æœ‰åˆå§‹åŒ–æ“ä½œ
                      await Promise.all([
                        fetchUserInfoByTelegram(userInfo.user_id),
                        fetchEmbyServers(userInfo.user_id),
                        fetchSiteSettings()
                      ]);
                      
                      console.log('åˆå§‹åŒ–å®Œæˆï¼Œç»§ç»­åŠ è½½ React åº”ç”¨');
                      return true;
                    } else {
                      showError('æ— æ³•è·å–ç”¨æˆ·IDï¼Œè¯·ä»Telegramæœºå™¨äººèœå•é‡æ–°æ‰“å¼€');
                      return false;
                    }
                  } catch (error) {
                    showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
                    return false;
                  }
                } else {
                  showError('æ— æ³•è·å–Telegramç”¨æˆ·ä¿¡æ¯ï¼Œè¯·ç¡®ä¿åœ¨Telegramä¸­æ­£ç¡®æ‰“å¼€æ­¤åº”ç”¨');
                  return false;
                }
              } else {
                // æ£€æŸ¥æ˜¯å¦åœ¨æ¡Œé¢æµè§ˆå™¨ä¸­è®¿é—®
                const isDesktopBrowser = !navigator.userAgent.includes('Telegram') && 
                                       !window.location.search.includes('tgWebAppData') &&
                                       !document.referrer.includes('telegram');
                
                if (isDesktopBrowser) {
                  // æ¡Œé¢æµè§ˆå™¨è®¿é—®ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
                  document.body.innerHTML = `
                    <div style="
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      display: flex; 
                      justify-content: center; 
                      align-items: center; 
                      height: 100vh; 
                      margin: 0; 
                      background: #f5f5f5;
                    ">
                      <div style="
                        text-align: center; 
                        background: white; 
                        padding: 40px; 
                        border-radius: 12px; 
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        max-width: 400px;
                      ">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“±</div>
                        <h1 style="color: #333; margin-bottom: 16px;">Telegram Web App</h1>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 20px;">æ­¤åº”ç”¨åªèƒ½åœ¨ Telegram ä¸­æ‰“å¼€</p>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 20px;">è¯·é€šè¿‡ Telegram æœºå™¨äººè®¿é—®æ­¤åº”ç”¨</p>
                        <a href="https://t.me/DockerManger_Bot" style="
                          display: inline-block; 
                          background: #0088cc; 
                          color: white; 
                          padding: 12px 24px; 
                          text-decoration: none; 
                          border-radius: 8px; 
                          font-weight: 500;
                        " onmouseover="this.style.background='#006699'" onmouseout="this.style.background='#0088cc'">
                          æ‰“å¼€ Telegram æœºå™¨äºº
                        </a>
                      </div>
                    </div>
                  `;
                  return false;
                } else {
                  showError('Telegram WebAppæœªæ­£ç¡®åŠ è½½ï¼Œè¯·é‡æ–°æ‰“å¼€');
                  return false;
                }
              }
            };
            
            // æ‰§è¡Œåˆå§‹åŒ–
            initializeData().then(success => {
              if (!success) {
                // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œé˜»æ­¢ React åº”ç”¨åŠ è½½
                window.stopReactApp = true;
              }
            });
          }
        })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
